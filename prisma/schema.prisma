datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

model Admin {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String   // bcrypt hashed
  role      String   @default("admin") // admin, doctor, receptionist
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments Appointment[] // doctors have appointments

  @@index([email])
}

model Patient {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String   @unique
  token     Int      @unique
  status    String   @default("waiting") // waiting, in-consultation, completed, cancelled
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  queueTokens QueueToken[]
  appointments Appointment[]

  @@index([token])
  @@index([phone])
  @@index([status]) // very important for live queue filtering
}

model QueueToken {
  id          Int      @id @default(autoincrement())
  token       Int
  status      String   @default("waiting")
  assignedAt  DateTime @default(now())
  completedAt DateTime? // when consultation ends

  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([token])
  @@index([status])
}

model Appointment {
  id          Int      @id @default(autoincrement())
  dateTime    DateTime
  status      String   @default("scheduled") // scheduled, in-progress, completed, cancelled
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  doctorId    Int
  doctor      Admin   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  medicalRecords MedicalRecord[]

  @@index([patientId])
  @@index([doctorId])
  @@index([dateTime])
  @@index([status])
}

model MedicalRecord {
  id            Int      @id @default(autoincrement())
  diagnosis     String
  prescription  String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  appointmentId Int
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
}